package com.devsecops.webapp.demo;

import org.springframework.stereotype.Service;
import java.sql.*;
import java.util.*;
import java.io.*;
import java.security.MessageDigest;
import java.util.regex.Pattern;

/**
 * DEMO CLASS - Contains intentional vulnerabilities for SonarQube demonstration
 * DO NOT USE IN PRODUCTION
 */
@Service
public class VulnerabilityDemoService {
    
    private String password = "hardcoded123"; // CRITICAL: Hardcoded password
    private static final String DB_URL = "jdbc:mysql://localhost:3306/test"; // INFO: Database URL
    
    // MAJOR BUG: Unused variable
    private String unusedVariable = "never used";
    
    // HIGH VULNERABILITY: SQL Injection
    public List<String> getUserData(String userId) throws SQLException {
        Connection conn = DriverManager.getConnection(DB_URL, "root", password);
        Statement stmt = conn.createStatement();
        
        // SQL Injection vulnerability - user input directly concatenated
        String query = "SELECT * FROM users WHERE id = '" + userId + "'";
        ResultSet rs = stmt.executeQuery(query);
        
        List<String> results = new ArrayList<>();
        while (rs.next()) {
            results.add(rs.getString("name"));
        }
        
        // MAJOR BUG: Resources not closed properly
        return results;
    }
    
    // MEDIUM VULNERABILITY: Weak cryptography
    public String hashPassword(String plainPassword) {
        try {
            MessageDigest md = MessageDigest.getInstance("MD5"); // Weak algorithm
            byte[] hash = md.digest(plainPassword.getBytes());
            StringBuilder sb = new StringBuilder();
            for (byte b : hash) {
                sb.append(String.format("%02x", b));
            }
            return sb.toString();
        } catch (Exception e) {
            return plainPassword; // MAJOR BUG: Returns plain password on error
        }
    }
    
    // HIGH VULNERABILITY: Path traversal
    public String readFile(String filename) {
        try {
            // No validation - allows path traversal attacks
            File file = new File("/app/data/" + filename);
            Scanner scanner = new Scanner(file);
            StringBuilder content = new StringBuilder();
            while (scanner.hasNextLine()) {
                content.append(scanner.nextLine());
            }
            // MINOR BUG: Scanner not closed
            return content.toString();
        } catch (Exception e) {
            return "Error reading file"; // MINOR: Generic error message
        }
    }
    
    // MEDIUM VULNERABILITY: Regex DoS
    public boolean validateEmail(String email) {
        // Vulnerable regex pattern - can cause ReDoS
        String pattern = "^([a-zA-Z0-9_\\-\\.]+)@([a-zA-Z0-9_\\-\\.]+)\\.([a-zA-Z]{2,5})$";
        return Pattern.matches(pattern, email);
    }
    
    // CODE SMELL: Too many parameters
    public void processUserData(String name, String email, String phone, String address, 
                               String city, String state, String zip, String country,
                               String company, String department, String role) {
        // CODE SMELL: Empty method body
        // CODE SMELL: Method too long parameter list
    }
    
    // CODE SMELL: Cognitive complexity
    public String determineUserLevel(int score, boolean isPremium, String userType, 
                                   int yearsActive, boolean hasReferrals) {
        if (score > 100) {
            if (isPremium) {
                if (userType.equals("enterprise")) {
                    if (yearsActive > 5) {
                        if (hasReferrals) {
                            return "platinum";
                        } else {
                            return "gold";
                        }
                    } else {
                        return "silver";
                    }
                } else {
                    return "bronze";
                }
            } else {
                return "basic";
            }
        } else {
            return "starter";
        }
    }
    
    // MAJOR BUG: Null pointer potential
    public int calculateTotal(List<Integer> numbers) {
        int total = 0;
        for (Integer num : numbers) { // No null check on list or elements
            total += num; // Potential NPE if num is null
        }
        return total;
    }
    
    // CODE SMELL: Duplicated code
    public void logUserAction(String action) {
        System.out.println("User action: " + action);
        System.out.println("Timestamp: " + new Date());
        System.out.println("Session: active");
    }
    
    // CODE SMELL: Duplicated code
    public void logSystemEvent(String event) {
        System.out.println("System event: " + event);
        System.out.println("Timestamp: " + new Date());
        System.out.println("Session: active");
    }
    
    // MINOR VULNERABILITY: Information disclosure
    public Map<String, Object> getDebugInfo() {
        Map<String, Object> debug = new HashMap<>();
        debug.put("database_password", password); // Exposes sensitive data
        debug.put("system_properties", System.getProperties());
        debug.put("environment", System.getenv());
        return debug;
    }
    
    // CODE SMELL: Magic numbers
    public boolean isValidAge(int age) {
        return age >= 18 && age <= 120; // Magic numbers without constants
    }
    
    // MAJOR BUG: Infinite loop potential
    public void processQueue(Queue<String> queue) {
        while (!queue.isEmpty()) {
            String item = queue.poll();
            if (item.equals("retry")) {
                queue.offer("retry"); // Can cause infinite loop
            }
            // Process item
        }
    }
}
